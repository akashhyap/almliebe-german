{% comment %}
  MAIN PRODUCT - Full Featured Product Page
  
  Features:
  - Image gallery with zoom
  - Size guide integration
  - Trust badges
  - Stock urgency indicators
  - Model measurements
  - Tabbed description
  - Complete the Look
  - Breadcrumbs
  - Product schema
{% endcomment %}

{%- liquid
  assign current_variant = product.selected_or_first_available_variant
  assign featured_media = product.selected_or_first_available_variant.featured_media | default: product.featured_media
  
  # Size option detection
  assign has_size_option = false
  assign size_option_position = nil
  for option in product.options_with_values
    assign option_name_lower = option.name | downcase
    if option_name_lower == 'size' or option_name_lower == 'größe'
      assign has_size_option = true
      assign size_option_position = forloop.index
      assign size_option = option
      break
    endif
  endfor
  
  # Color option detection
  assign has_color_option = false
  for option in product.options_with_values
    assign option_name_lower = option.name | downcase
    if option_name_lower == 'color' or option_name_lower == 'colour' or option_name_lower == 'farbe'
      assign has_color_option = true
      assign color_option_position = forloop.index
      assign color_option = option
      break
    endif
  endfor
  
  # Stock calculation
  assign total_inventory = 0
  assign show_low_stock = false
  for variant in product.variants
    if variant.inventory_management and variant.inventory_quantity > 0
      assign total_inventory = total_inventory | plus: variant.inventory_quantity
    endif
  endfor
  if total_inventory > 0 and total_inventory <= settings.low_stock_threshold
    assign show_low_stock = true
  endif
-%}

{%- comment -%} Breadcrumbs {%- endcomment -%}
<div class="container">
  {% render 'breadcrumbs', type: 'product', product: product %}
</div>

<section class="product-page section" data-product-page>
  <div class="container">
    <div class="product-page__grid">
      
      {%- comment -%} ========== PRODUCT GALLERY ========== {%- endcomment -%}
      <div class="product__gallery" data-product-gallery>
        {%- comment -%} Main Image {%- endcomment -%}
        <div class="product__media-main" data-main-image-container>
          {%- for media in product.media -%}
            <div 
              class="product__media-item{% if forloop.first %} is-active{% endif %}" 
              data-media-id="{{ media.id }}"
              data-index="{{ forloop.index0 }}"
            >
              {%- case media.media_type -%}
                {%- when 'image' -%}
                  <div class="product__image-wrapper" data-zoom-wrapper>
                    <img
                      class="product__image"
                      src="{{ media | image_url: width: 1200 }}"
                      srcset="{{ media | image_url: width: 600 }} 600w,
                              {{ media | image_url: width: 900 }} 900w,
                              {{ media | image_url: width: 1200 }} 1200w,
                              {{ media | image_url: width: 1800 }} 1800w"
                      sizes="(min-width: 1200px) 50vw, 100vw"
                      alt="{{ media.alt | escape | default: product.title }}"
                      width="{{ media.width }}"
                      height="{{ media.height }}"
                      {% if forloop.first %}fetchpriority="high"{% else %}loading="lazy"{% endif %}
                      data-zoom-image="{{ media | image_url: width: 2400 }}"
                    >
                    <button type="button" class="product__zoom-btn" data-zoom-trigger aria-label="{{ 'products.product.zoom' | t | default: 'Bild vergrößern' }}">
                      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                        <path d="M11 8v6M8 11h6"/>
                      </svg>
                    </button>
                  </div>
                  
                {%- when 'video' -%}
                  <div class="product__video-wrapper">
                    {{ media | video_tag: autoplay: false, loop: true, controls: true, muted: false }}
                  </div>
                  
                {%- when 'external_video' -%}
                  <div class="product__video-wrapper product__video-wrapper--external">
                    {{ media | external_video_tag }}
                  </div>
              {%- endcase -%}
            </div>
          {%- endfor -%}
          
          {%- comment -%} Navigation Arrows {%- endcomment -%}
          {%- if product.media.size > 1 -%}
            <button type="button" class="product__gallery-nav product__gallery-nav--prev" data-gallery-prev aria-label="Previous image">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
              </svg>
            </button>
            <button type="button" class="product__gallery-nav product__gallery-nav--next" data-gallery-next aria-label="Next image">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"/>
              </svg>
            </button>
          {%- endif -%}
        </div>

        {%- comment -%} Thumbnail Strip {%- endcomment -%}
        {%- if product.media.size > 1 -%}
          <div class="product__thumbnails" data-thumbnails>
            {%- for media in product.media -%}
              <button 
                type="button"
                class="product__thumbnail{% if forloop.first %} is-active{% endif %}"
                data-thumbnail
                data-media-id="{{ media.id }}"
                data-index="{{ forloop.index0 }}"
                aria-label="View image {{ forloop.index }}"
              >
                <img
                  src="{{ media | image_url: width: 150 }}"
                  alt="{{ media.alt | escape | default: product.title }}"
                  width="75"
                  height="100"
                  loading="lazy"
                >
                {%- if media.media_type == 'video' or media.media_type == 'external_video' -%}
                  <span class="product__thumbnail-video-icon">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                      <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                  </span>
                {%- endif -%}
              </button>
            {%- endfor -%}
          </div>
        {%- endif -%}
      </div>

      {%- comment -%} ========== PRODUCT INFO ========== {%- endcomment -%}
      <div class="product__info">
        
        {%- comment -%} Vendor/Brand {%- endcomment -%}
        {%- if settings.show_vendor and product.vendor != blank -%}
          <p class="product__vendor">
            <a href="{{ product.vendor | url_for_vendor }}">{{ product.vendor }}</a>
          </p>
        {%- endif -%}

        {%- comment -%} Title {%- endcomment -%}
        <h1 class="product__title">{{ product.title }}</h1>

        {%- comment -%} Reviews Summary {%- endcomment -%}
        <div class="product__reviews-summary" data-reviews-summary>
          {%- comment -%} Judge.me or Shopify Reviews hook {%- endcomment -%}
          <span class="jdgm-prev-badge" data-id="{{ product.id }}"></span>
        </div>

        {%- comment -%} Price {%- endcomment -%}
        <div class="product__price" data-product-price>
          {%- if current_variant.available -%}
            {%- if current_variant.compare_at_price > current_variant.price -%}
              <span class="price__sale">{{ current_variant.price | money }}</span>
              <span class="price__compare">{{ current_variant.compare_at_price | money }}</span>
              {%- assign savings = current_variant.compare_at_price | minus: current_variant.price -%}
              <span class="price__savings">({{ 'products.product.save' | t | default: 'Sie sparen' }} {{ savings | money }})</span>
            {%- else -%}
              <span class="price__regular">{{ current_variant.price | money }}</span>
            {%- endif -%}
          {%- else -%}
            <span class="price__soldout">{{ 'products.product.sold_out' | t }}</span>
          {%- endif -%}
          
          {%- if settings.show_vat_included -%}
            <span class="price__note">
              {{ 'products.product.vat_included' | t | default: 'inkl. MwSt.' }}
              {%- if settings.show_shipping_note -%}
                <a href="{{ pages[settings.page_versand].url | default: '/policies/shipping-policy' }}">{{ 'products.product.shipping_info' | t | default: 'zzgl. Versandkosten' }}</a>
              {%- endif -%}
            </span>
          {%- endif -%}
        </div>

        {%- comment -%} Stock Urgency {%- endcomment -%}
        {%- if show_low_stock -%}
          <div class="product__stock-warning">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/>
            </svg>
            {{ 'products.product.only_x_left' | t: count: total_inventory | default: 'Nur noch' | append: ' ' | append: total_inventory | append: ' auf Lager!' }}
          </div>
        {%- endif -%}

        {%- comment -%} Model Measurements {%- endcomment -%}
        {%- if product.metafields.custom.model_info != blank -%}
          <p class="product__model-info">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
            </svg>
            {{ product.metafields.custom.model_info }}
          </p>
        {%- endif -%}

        {%- comment -%} Product Form {%- endcomment -%}
        <form 
          method="post" 
          action="/cart/add" 
          id="ProductForm-{{ section.id }}"
          class="product__form"
          data-product-form
          data-product-id="{{ product.id }}"
        >
          <input type="hidden" name="id" value="{{ current_variant.id }}" data-variant-id>

          {%- comment -%} Variant Selectors {%- endcomment -%}
          {%- unless product.has_only_default_variant -%}
            <div class="product__variants">
              {%- for option in product.options_with_values -%}
                {%- assign option_name_lower = option.name | downcase -%}
                
                <div class="product__option" data-option-position="{{ option.position }}">
                  <div class="product__option-header">
                    <label class="product__option-label">
                      {{ option.name }}:
                      <span class="product__option-value" data-selected-option="{{ option.position }}">{{ option.selected_value }}</span>
                    </label>
                    
                    {%- comment -%} Size Guide Link {%- endcomment -%}
                    {%- if option_name_lower == 'size' or option_name_lower == 'größe' -%}
                      {%- if settings.enable_size_guide -%}
                        <button type="button" class="product__size-guide-link" data-modal-open="SizeGuideModal">
                          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                          </svg>
                          {{ 'products.product.size_guide' | t | default: 'Größentabelle' }}
                        </button>
                      {%- endif -%}
                    {%- endif -%}
                  </div>

                  {%- comment -%} Color swatches vs regular options {%- endcomment -%}
                  {%- if option_name_lower == 'color' or option_name_lower == 'colour' or option_name_lower == 'farbe' -%}
                    <div class="product__option-swatches">
                      {%- for value in option.values -%}
                        {%- assign swatch_color = value | handleize -%}
                        <label class="product__swatch" data-option-value="{{ value | escape }}" title="{{ value }}">
                          <input 
                            type="radio" 
                            name="option{{ option.position }}" 
                            value="{{ value | escape }}"
                            {% if option.selected_value == value %}checked{% endif %}
                            data-single-option-selector
                          >
                          <span class="product__swatch-color" style="background-color: {{ swatch_color }}; background-image: url('{{ value | handleize | append: '.png' | file_url }}');"></span>
                        </label>
                      {%- endfor -%}
                    </div>
                  {%- else -%}
                    <div class="product__option-buttons">
                      {%- for value in option.values -%}
                        {%- liquid
                          assign variant_available = false
                          assign option_index = option.position | minus: 1
                          for variant in product.variants
                            if variant.options[option_index] == value and variant.available
                              assign variant_available = true
                              break
                            endif
                          endfor
                        -%}
                        <label class="product__option-btn{% unless variant_available %} product__option-btn--unavailable{% endunless %}" data-option-value="{{ value | escape }}">
                          {%- unless variant_available -%}
                            <span class="stock-alert-bell" data-stock-alert-trigger="{{ value | escape }}" title="Benachrichtigung bei Verfügbarkeit">
                              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                              </svg>
                            </span>
                          {%- endunless -%}
                          <input 
                            type="radio" 
                            name="option{{ option.position }}" 
                            value="{{ value | escape }}"
                            {% if option.selected_value == value %}checked{% endif %}
                            {% unless variant_available %}disabled{% endunless %}
                            data-single-option-selector
                          >
                          <span>{{ value }}</span>
                        </label>
                      {%- endfor -%}
                    </div>
                  {%- endif -%}
                </div>
              {%- endfor -%}
            </div>
          {%- endunless -%}

          {%- comment -%} Quantity & Add to Cart {%- endcomment -%}
          <div class="product__actions">
            <div class="product__quantity">
              <label class="visually-hidden" for="Quantity-{{ section.id }}">{{ 'products.product.quantity' | t }}</label>
              <button type="button" class="quantity__button" data-quantity-minus aria-label="Decrease quantity">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
              </button>
              <input 
                type="number" 
                id="Quantity-{{ section.id }}"
                name="quantity" 
                value="1" 
                min="1" 
                class="quantity__input"
                data-quantity-input
              >
              <button type="button" class="quantity__button" data-quantity-plus aria-label="Increase quantity">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
              </button>
            </div>

            <button 
              type="submit" 
              class="product__add-btn btn btn--primary btn--large"
              data-add-to-cart
              {% unless current_variant.available %}disabled{% endunless %}
              style="background-color: #000000 !important; border-color: #000000 !important;"
            >
              <span data-add-to-cart-text>
                {%- if current_variant.available -%}
                  {{ 'products.product.add_to_cart' | t | default: 'In den Warenkorb' }}
                {%- else -%}
                  {{ 'products.product.sold_out' | t | default: 'Ausverkauft' }}
                {%- endif -%}
              </span>
              <span class="product__add-btn-loading" hidden style="display: none;">
                <span class="spinner spinner--small"></span>
              </span>
            </button>
          </div>

          {%- comment -%} Buy Now Button {%- endcomment -%}
          {%- if settings.show_dynamic_checkout -%}
            <div class="product__buy-now">
              {{ form | payment_button }}
            </div>
          {%- endif -%}
        </form>

        {%- comment -%} Trust Badges {%- endcomment -%}
        <div class="product__trust-badges">
          <div class="trust-badge">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="1" y="3" width="15" height="13" rx="2"/><path d="m16 8 5 3-5 3z"/>
            </svg>
            <span>{{ 'products.product.free_shipping' | t | default: 'Kostenloser Versand ab 99€' }}</span>
          </div>
          <div class="trust-badge">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            <span>{{ 'products.product.returns' | t | default: '14 Tage Rückgaberecht' }}</span>
          </div>
          <div class="trust-badge">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            <span>{{ 'products.product.secure' | t | default: 'Sichere Zahlung' }}</span>
          </div>
        </div>

        {%- comment -%} Shipping Estimate {%- endcomment -%}
        <div class="product__shipping-estimate">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
            <circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
          </svg>
          <span>
            {{ 'products.product.shipping_estimate' | t | default: 'Lieferung in 2-4 Werktagen' }}
          </span>
        </div>

        {%- comment -%} Product Description Tabs {%- endcomment -%}
        <div class="product__tabs" data-product-tabs>
          <div class="product__tabs-nav">
            <button type="button" class="product__tab-btn is-active" data-tab="description">
              {{ 'products.product.description' | t | default: 'Beschreibung' }}
            </button>
            {%- if product.metafields.custom.materials != blank -%}
              <button type="button" class="product__tab-btn" data-tab="materials">
                {{ 'products.product.materials' | t | default: 'Material & Pflege' }}
              </button>
            {%- endif -%}
            {%- if has_size_option -%}
              <button type="button" class="product__tab-btn" data-tab="sizing">
                {{ 'products.product.sizing' | t | default: 'Größeninfo' }}
              </button>
            {%- endif -%}
            <button type="button" class="product__tab-btn" data-tab="shipping">
              {{ 'products.product.shipping' | t | default: 'Versand' }}
            </button>
          </div>

          <div class="product__tabs-content">
            <div class="product__tab-panel is-active" data-tab-panel="description">
              <div class="product__description rte">
                {{ product.description }}
              </div>
            </div>

            {%- if product.metafields.custom.materials != blank -%}
              <div class="product__tab-panel" data-tab-panel="materials">
                <div class="rte">
                  {{ product.metafields.custom.materials | metafield_tag }}
                </div>
              </div>
            {%- endif -%}

            {%- if has_size_option -%}
              <div class="product__tab-panel" data-tab-panel="sizing">
                <div class="product__sizing-info">
                  {%- if product.metafields.custom.fit_info != blank -%}
                    <p class="product__fit-info">{{ product.metafields.custom.fit_info }}</p>
                  {%- endif -%}
                  <button type="button" class="btn btn--secondary" data-modal-open="SizeGuideModal">
                    {{ 'products.product.view_size_guide' | t | default: 'Vollständige Größentabelle anzeigen' }}
                  </button>
                </div>
              </div>
            {%- endif -%}

            <div class="product__tab-panel" data-tab-panel="shipping">
              <div class="rte">
                <p>{{ 'products.product.shipping_text' | t | default: 'Kostenloser Versand ab 99€ Bestellwert. Lieferung innerhalb Deutschlands in 2-4 Werktagen.' }}</p>
                <p><a href="{{ pages[settings.page_versand].url | default: '/policies/shipping-policy' }}">{{ 'products.product.more_shipping_info' | t | default: 'Mehr Versandinformationen' }}</a></p>
              </div>
            </div>
          </div>
        </div>

        {%- comment -%} SKU & Share {%- endcomment -%}
        <div class="product__meta">
          {%- if settings.show_sku and current_variant.sku != blank -%}
            <p class="product__sku">
              <span>{{ 'products.product.sku' | t | default: 'Artikelnr.' }}:</span>
              <span data-product-sku>{{ current_variant.sku }}</span>
            </p>
          {%- endif -%}

          <div class="product__share">
            <span>{{ 'products.product.share' | t | default: 'Teilen' }}:</span>
            {%- if settings.share_facebook -%}
              <a href="https://www.facebook.com/sharer/sharer.php?u={{ product.url | absolute_url }}" target="_blank" rel="noopener" aria-label="Share on Facebook">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
              </a>
            {%- endif -%}
            {%- if settings.share_pinterest -%}
              <a href="https://pinterest.com/pin/create/button/?url={{ product.url | absolute_url }}&media={{ featured_media | image_url: width: 1200 }}&description={{ product.title | url_encode }}" target="_blank" rel="noopener" aria-label="Pin on Pinterest">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0a12 12 0 0 0-4.37 23.17c-.1-.94-.2-2.4.04-3.44l1.4-5.96s-.35-.7-.35-1.75c0-1.64.95-2.87 2.13-2.87 1 0 1.49.75 1.49 1.66 0 1-.65 2.5-.98 3.9-.27 1.16.58 2.1 1.72 2.1 2.08 0 3.67-2.19 3.67-5.34 0-2.8-2-4.76-4.87-4.76-3.32 0-5.27 2.49-5.27 5.07 0 1 .38 2.08.87 2.67a.35.35 0 0 1 .08.33l-.33 1.32c-.05.2-.16.25-.38.15-1.4-.65-2.26-2.7-2.26-4.33 0-3.54 2.57-6.78 7.4-6.78 3.88 0 6.9 2.77 6.9 6.46 0 3.86-2.43 6.96-5.8 6.96-1.14 0-2.2-.6-2.57-1.3l-.7 2.65c-.25.97-.93 2.18-1.4 2.92A12 12 0 1 0 12 0z"/></svg>
              </a>
            {%- endif -%}
            {%- if settings.share_whatsapp -%}
              <a href="https://wa.me/?text={{ product.title | url_encode }}%20{{ product.url | absolute_url }}" target="_blank" rel="noopener" aria-label="Share on WhatsApp">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M17.47 14.38c-.28-.14-1.64-.81-1.9-.9-.25-.09-.43-.14-.61.14-.18.28-.7.9-.86 1.09-.16.18-.31.2-.58.07-.28-.14-1.17-.43-2.23-1.38-.82-.73-1.38-1.64-1.54-1.92-.16-.28-.02-.43.12-.57.13-.12.28-.32.42-.48.14-.16.19-.28.28-.46.1-.18.05-.34-.02-.48-.07-.14-.61-1.47-.83-2.01-.22-.53-.44-.46-.61-.47h-.52c-.18 0-.48.07-.73.34s-.96.94-.96 2.29c0 1.35.98 2.65 1.12 2.83.14.18 1.93 2.95 4.69 4.13.65.28 1.16.45 1.56.58.66.21 1.26.18 1.73.11.53-.08 1.64-.67 1.87-1.32.23-.65.23-1.2.16-1.32-.07-.12-.25-.19-.53-.33zm-5.42 7.4a9.87 9.87 0 0 1-5.03-1.38l-.36-.21-3.74.98 1-3.65-.24-.38a9.86 9.86 0 0 1-1.51-5.26c0-5.45 4.44-9.89 9.9-9.89a9.83 9.83 0 0 1 7 2.9 9.83 9.83 0 0 1 2.9 7c0 5.45-4.44 9.89-9.92 9.89zm8.42-18.31A11.82 11.82 0 0 0 12.05 0C5.46 0 .1 5.35.1 11.94c0 2.1.55 4.16 1.6 5.97L0 24l6.3-1.65a11.9 11.9 0 0 0 5.74 1.46c6.59 0 11.94-5.35 11.94-11.94a11.87 11.87 0 0 0-3.51-8.4z"/></svg>
              </a>
            {%- endif -%}
          </div>
        </div>
      </div>
    </div>

    {%- comment -%} Complete the Look / Complementary Products {%- endcomment -%}
    {%- if product.metafields.custom.complementary_products != blank -%}
      <section class="product__complete-look section--small">
        <h2 class="section-title">{{ 'products.product.complete_look' | t | default: 'Komplettieren Sie Ihren Look' }}</h2>
        <div class="grid grid--2-col grid--4-col-desktop">
          {%- for comp_product in product.metafields.custom.complementary_products.value -%}
            {% render 'product-card', product: comp_product, lazy: true %}
          {%- endfor -%}
        </div>
      </section>
    {%- endif -%}
  </div>
</section>

{%- comment -%} 
  Related Products - Add this section in your product.json template instead:
  "related-products": { "type": "related-products" }
  Cannot render sections inside sections in Shopify.
{%- endcomment -%}

{%- comment -%} Product Schema {%- endcomment -%}
{% render 'product-schema', product: product %}

<style>
  .product-page__grid {
    display: grid;
    gap: 2rem;
  }

  @media (min-width: 1024px) {
    .product-page__grid {
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
    }
  }

  /* Gallery */
  .product__gallery {
    position: relative;
  }

  .product__media-main {
    position: relative;
    overflow: hidden;
    border-radius: var(--border-radius);
    background: var(--color-background-secondary);
  }

  .product__media-item {
    display: none;
  }

  .product__media-item.is-active {
    display: block;
  }

  .product__image-wrapper {
    position: relative;
    cursor: zoom-in;
  }

  .product__image {
    width: 100%;
    height: auto;
    display: block;
  }

  .product__zoom-btn {
    position: absolute;
    bottom: 1rem;
    right: 1rem;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    opacity: 0;
    transition: opacity 0.2s;
  }

  .product__media-main:hover .product__zoom-btn {
    opacity: 1;
  }

  .product__gallery-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    z-index: 2;
  }

  .product__gallery-nav--prev { left: 1rem; }
  .product__gallery-nav--next { right: 1rem; }

  .product__thumbnails {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.75rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }

  .product__thumbnail {
    position: relative;
    flex-shrink: 0;
    width: 60px;
    height: 80px;
    padding: 0;
    background: none;
    border: 2px solid transparent;
    border-radius: calc(var(--border-radius) / 2);
    cursor: pointer;
    overflow: hidden;
    transition: border-color 0.2s;
  }

  .product__thumbnail.is-active,
  .product__thumbnail:hover {
    border-color: #000000;
  }

  .product__thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product__thumbnail-video-icon {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.3);
    color: white;
  }

  /* Product Info */
  .product__info {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  @media (min-width: 1024px) {
    .product__info {
      position: sticky;
      top: calc(var(--header-height) + 2rem);
      align-self: start;
    }
  }

  .product__vendor {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin: 0;
  }

  .product__vendor a {
    color: var(--color-text-secondary);
  }

  .product__title {
    font-size: 1.75rem;
    margin: 0;
  }

  .product__price {
    display: flex;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .product__price .price__sale {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--color-sale);
  }

  .product__price .price__regular {
    font-size: 1.5rem;
    font-weight: 600;
  }

  .product__price .price__compare {
    font-size: 1rem;
    color: var(--color-text-secondary);
    text-decoration: line-through;
  }

  .product__price .price__savings {
    font-size: 0.875rem;
    color: var(--color-sale);
  }

  .product__price .price__note {
    width: 100%;
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .product__stock-warning {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    background: rgba(139, 38, 53, 0.1);
    border-left: 3px solid var(--color-sale);
    border-radius: var(--border-radius);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-sale);
  }

  .product__model-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* Variant Options */
  .product__variants {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .product__option-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }

  .product__option-label {
    font-size: 0.875rem;
    font-weight: 600;
  }

  .product__option-value {
    font-weight: 400;
    color: var(--color-text-secondary);
    margin-left: 0.25rem;
  }

  .product__size-guide-link {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.8125rem;
    color: #000000;
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
  }

  .product__size-guide-link:hover {
    text-decoration: underline;
  }

  .product__option-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .product__option-btn {
    position: relative;
  }

  .product__option-btn input {
    position: absolute;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
  }

  .product__option-btn > span:last-child {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 3rem;
    height: 2.75rem;
    padding: 0 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    border: 1px solid var(--color-border);
    border-radius: calc(var(--border-radius) / 2);
    transition: all 0.2s;
  }

  .product__option-btn input:checked + span,
  .product__option-btn input:checked ~ span:last-child {
    border-color: #000000;
    background: #000000;
    color: white;
  }

  .product__option-btn:hover:not(.product__option-btn--unavailable) > span:last-child {
    border-color: #000000;
  }

  .product__option-btn--unavailable {
    opacity: 0.7;
    position: relative;
  }

  .product__option-btn--unavailable > span:last-child {
    text-decoration: line-through;
  }
  
  .product__option-btn--unavailable input {
    cursor: not-allowed;
  }
  
  /* Stock Alert Bell Icon - Clean minimal style */
  .stock-alert-bell {
    position: absolute;
    top: -6px;
    left: 50%;
    transform: translateX(-50%);
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    cursor: pointer;
    z-index: 5;
    padding: 0;
  }
  
  .stock-alert-bell:hover svg {
    stroke: #000000;
    transform: scale(1.1);
  }
  
  .stock-alert-bell svg {
    width: 14px;
    height: 14px;
    stroke: #666666;
    transition: all 0.2s ease;
  }

  /* Color swatches */
  .product__option-swatches {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .product__swatch {
    position: relative;
    cursor: pointer;
  }

  .product__swatch input {
    position: absolute;
    opacity: 0;
  }

  .product__swatch-color {
    display: block;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    border: 2px solid transparent;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
    background-size: cover;
    transition: border-color 0.2s, transform 0.2s;
  }

  .product__swatch input:checked + .product__swatch-color {
    border-color: #000000;
    transform: scale(1.1);
  }

  .product__swatch:hover .product__swatch-color {
    transform: scale(1.1);
  }

  /* Actions */
  .product__actions {
    display: flex;
    gap: 1rem;
    margin-top: 0.5rem;
  }

  /* Quantity Selector - Clean Minimal Style */
  .product__quantity {
    display: inline-flex;
    align-items: center;
    border: 1.5px solid #e5e5e5;
    border-radius: 8px;
    background: #ffffff;
    overflow: hidden;
  }
  
  .quantity__button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    background: #fafafa;
    border: none;
    cursor: pointer;
    transition: all 0.15s ease;
    color: #374151;
  }
  
  .quantity__button:hover {
    background: #f3f4f6;
    color: #111827;
  }
  
  .quantity__button:active {
    background: #e5e7eb;
  }
  
  .quantity__button svg {
    width: 16px;
    height: 16px;
    stroke-width: 2;
  }
  
  .quantity__input {
    width: 56px;
    height: 44px;
    text-align: center;
    font-size: 0.9375rem;
    font-weight: 500;
    color: #111827;
    background: #ffffff;
    border: none;
    border-left: 1.5px solid #e5e5e5;
    border-right: 1.5px solid #e5e5e5;
    -moz-appearance: textfield;
    appearance: textfield;
  }
  
  .quantity__input::-webkit-outer-spin-button,
  .quantity__input::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
  }
  
  .quantity__input:focus {
    outline: none;
    background: #f9fafb;
  }

  .product__add-btn {
    flex: 1;
    position: relative;
  }

  .product__add-btn-loading {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: inherit;
  }

  .spinner--small {
    width: 20px;
    height: 20px;
    border-width: 2px;
  }

  /* Trust Badges */
  .product__trust-badges {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    padding: 1rem 0;
    border-top: 1px solid var(--color-border);
    border-bottom: 1px solid var(--color-border);
  }

  .trust-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
  }

  .trust-badge svg {
    color: #000000;
    flex-shrink: 0;
  }

  /* Shipping Estimate */
  .product__shipping-estimate {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--color-success);
  }

  /* Tabs */
  .product__tabs {
    margin-top: 1rem;
  }

  .product__tabs-nav {
    display: flex;
    gap: 0;
    border-bottom: 1px solid var(--color-border);
    overflow-x: auto;
  }

  .product__tab-btn {
    padding: 0.75rem 1rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
  }

  .product__tab-btn.is-active {
    color: var(--color-text);
    border-bottom-color: #000000;
  }

  .product__tab-panel {
    display: none;
    padding: 1.25rem 0;
  }

  .product__tab-panel.is-active {
    display: block;
  }

  .product__description.rte {
    font-size: 0.9375rem;
    line-height: 1.7;
  }

  /* Meta */
  .product__meta {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    gap: 1rem;
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    margin-top: 1rem;
  }

  .product__sku {
    margin: 0;
  }

  .product__share {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .product__share a {
    color: var(--color-text-secondary);
    transition: color 0.2s;
  }

  .product__share a:hover {
    color: #000000;
  }

  /* Complete the Look */
  .product__complete-look {
    margin-top: 3rem;
    padding-top: 3rem;
    border-top: 1px solid var(--color-border);
  }

  .section-title {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    text-align: center;
  }
</style>

<script>

document.addEventListener('DOMContentLoaded', function() {
  
  const page = document.querySelector('[data-product-page]');
  
  if (!page) {
    return;
  }

  // Gallery functionality
  const mainContainer = page.querySelector('[data-main-image-container]');
  const mediaItems = mainContainer?.querySelectorAll('[data-media-id]');
  const thumbnails = page.querySelectorAll('[data-thumbnail]');
  const prevBtn = page.querySelector('[data-gallery-prev]');
  const nextBtn = page.querySelector('[data-gallery-next]');
  let currentIndex = 0;

  function showMedia(index) {
    if (!mediaItems || index < 0 || index >= mediaItems.length) return;
    
    mediaItems.forEach((item, i) => {
      item.classList.toggle('is-active', i === index);
    });
    
    thumbnails.forEach((thumb, i) => {
      thumb.classList.toggle('is-active', i === index);
    });
    
    currentIndex = index;
  }

  thumbnails.forEach(thumb => {
    thumb.addEventListener('click', () => {
      const index = parseInt(thumb.dataset.index);
      showMedia(index);
    });
  });

  prevBtn?.addEventListener('click', () => {
    const newIndex = currentIndex === 0 ? mediaItems.length - 1 : currentIndex - 1;
    showMedia(newIndex);
  });

  nextBtn?.addEventListener('click', () => {
    const newIndex = currentIndex === mediaItems.length - 1 ? 0 : currentIndex + 1;
    showMedia(newIndex);
  });

  // Touch swipe for gallery
  let touchStartX = 0;
  mainContainer?.addEventListener('touchstart', e => {
    touchStartX = e.touches[0].clientX;
  });

  mainContainer?.addEventListener('touchend', e => {
    const touchEndX = e.changedTouches[0].clientX;
    const diff = touchStartX - touchEndX;
    
    if (Math.abs(diff) > 50) {
      if (diff > 0) {
        nextBtn?.click();
      } else {
        prevBtn?.click();
      }
    }
  });

  // Quantity buttons
  const quantityInput = page.querySelector('[data-quantity-input]');
  const minusBtn = page.querySelector('[data-quantity-minus]');
  const plusBtn = page.querySelector('[data-quantity-plus]');

  minusBtn?.addEventListener('click', () => {
    const current = parseInt(quantityInput.value) || 1;
    if (current > 1) quantityInput.value = current - 1;
  });

  plusBtn?.addEventListener('click', () => {
    const current = parseInt(quantityInput.value) || 1;
    quantityInput.value = current + 1;
  });

  // Stock Alert Bell - Open drawer when clicking on bell icon
  const stockAlertBells = page.querySelectorAll('[data-stock-alert-trigger]');
  
  const stockAlertProductData = {
    productId: {{ product.id | json }},
    title: {{ product.title | json }},
    image: {{ product.featured_image | image_url: width: 200 | json }},
    unavailableVariants: [
      {%- for variant in product.variants -%}
        {%- unless variant.available -%}
          {
            id: {{ variant.id | json }},
            title: {{ variant.title | json }},
            option: {{ variant.option1 | default: variant.option2 | default: variant.option3 | json }}
          },
        {%- endunless -%}
      {%- endfor -%}
    ]
  };
  
  stockAlertBells.forEach(function(bell) {
    bell.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      var clickedSize = this.dataset.stockAlertTrigger;
      var productData = JSON.parse(JSON.stringify(stockAlertProductData));
      
      // Pre-select the clicked size
      var clickedVariantIndex = productData.unavailableVariants.findIndex(function(v) { 
        return v.option === clickedSize; 
      });
      if (clickedVariantIndex > 0) {
        var clicked = productData.unavailableVariants.splice(clickedVariantIndex, 1)[0];
        productData.unavailableVariants.unshift(clicked);
      }
      
      // Open the drawer
      if (typeof window.openStockAlertDrawer === 'function') {
        window.openStockAlertDrawer(productData);
      } else {
        alert('Benachrichtigungs-Funktion nicht verfügbar.');
      }
    });
  });

  // Tabs
  const tabBtns = page.querySelectorAll('[data-tab]');
  const tabPanels = page.querySelectorAll('[data-tab-panel]');

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tab;
      
      tabBtns.forEach(b => b.classList.remove('is-active'));
      tabPanels.forEach(p => p.classList.remove('is-active'));
      
      btn.classList.add('is-active');
      page.querySelector(`[data-tab-panel="${tab}"]`)?.classList.add('is-active');
    });
  });

  // Variant selector
  const form = page.querySelector('[data-product-form]');
  const productId = form?.dataset.productId;
  const variantIdInput = form?.querySelector('[data-variant-id]');
  const optionInputs = form?.querySelectorAll('[data-single-option-selector]');
  const priceContainer = page.querySelector('[data-product-price]');
  const addToCartBtn = page.querySelector('[data-add-to-cart]');
  const addToCartText = page.querySelector('[data-add-to-cart-text]');
  const skuElement = page.querySelector('[data-product-sku]');

  if (optionInputs && productId) {
    optionInputs.forEach(input => {
      // Use both click and change events for better compatibility
      const handleOptionChange = async function() {
        // Update selected value display
        const optionPosition = this.closest('[data-option-position]')?.dataset.optionPosition;
        const selectedDisplay = page.querySelector(`[data-selected-option="${optionPosition}"]`);
        if (selectedDisplay) {
          selectedDisplay.textContent = this.value;
        }

        // Get all selected options
        const selectedOptions = [];
        page.querySelectorAll('[data-option-position]').forEach(optionGroup => {
          const checked = optionGroup.querySelector('input:checked');
          if (checked) selectedOptions.push(checked.value);
        });

        // Fetch product data and find matching variant
        try {
          const response = await fetch(`/products/${productId}.js`);
          const product = await response.json();
          
          const variant = product.variants.find(v => {
            return selectedOptions.every((opt, i) => v.options[i] === opt);
          });

          if (variant) {
            // Update variant ID
            variantIdInput.value = variant.id;
            
            // Update URL
            const url = new URL(window.location);
            url.searchParams.set('variant', variant.id);
            window.history.replaceState({}, '', url);

            // Update price
            if (priceContainer) {
              let priceHTML = '';
              if (variant.available) {
                if (variant.compare_at_price > variant.price) {
                  const savings = variant.compare_at_price - variant.price;
                  priceHTML = `
                    <span class="price__sale">${formatMoney(variant.price)}</span>
                    <span class="price__compare">${formatMoney(variant.compare_at_price)}</span>
                    <span class="price__savings">(Sie sparen ${formatMoney(savings)})</span>
                  `;
                } else {
                  priceHTML = `<span class="price__regular">${formatMoney(variant.price)}</span>`;
                }
              } else {
                priceHTML = `<span class="price__soldout">Ausverkauft</span>`;
              }
              
              // Keep price note
              const priceNote = priceContainer.querySelector('.price__note');
              priceContainer.innerHTML = priceHTML;
              if (priceNote) priceContainer.appendChild(priceNote);
            }

            // Update button
            if (addToCartBtn && addToCartText) {
              if (variant.available) {
                addToCartBtn.disabled = false;
                addToCartText.textContent = window.almliebe?.strings?.addToCart || 'In den Warenkorb';
              } else {
                addToCartBtn.disabled = true;
                addToCartText.textContent = window.almliebe?.strings?.soldOut || 'Ausverkauft';
              }
            }

            // Update SKU
            if (skuElement && variant.sku) {
              skuElement.textContent = variant.sku;
            }

            // Update gallery to variant image
            if (variant.featured_media) {
              const mediaIndex = [...mediaItems].findIndex(
                item => parseInt(item.dataset.mediaId) === variant.featured_media.id
              );
              if (mediaIndex > -1) showMedia(mediaIndex);
            }
          }
        } catch (error) {
          console.error('Error updating variant', error);
        }
      };
      
      input.addEventListener('change', handleOptionChange);
      input.addEventListener('click', function() {
        if (!this.disabled) {
          this.checked = true;
          handleOptionChange.call(this);
        }
      });
    });
  }

  function formatMoney(cents) {
    return window.almliebe?.formatMoney?.(cents) || 
      new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(cents / 100);
  }

  // ADD TO CART FORM SUBMISSION
  
  if (form) {
    
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const submitBtn = form.querySelector('[data-add-to-cart]');
      const submitText = form.querySelector('[data-add-to-cart-text]');
      const submitLoading = form.querySelector('.product__add-btn-loading');
      
      // Show loading state
      if (submitText) submitText.hidden = true;
      if (submitLoading) submitLoading.hidden = false;
      if (submitBtn) submitBtn.disabled = true;
      
      const formData = new FormData(form);
      
      try {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          body: formData
        });
        
        
        if (response.ok) {
          const item = await response.json();
          
          // Dispatch events for cart drawer
          document.dispatchEvent(new CustomEvent('cart:item-added', { detail: item }));
          document.dispatchEvent(new CustomEvent('cart:updated'));
          
          // Show success state briefly
          if (submitText) {
            submitText.hidden = false;
            submitText.textContent = '✓ Hinzugefügt';
          }
          if (submitLoading) submitLoading.hidden = true;
          
          // Reset button after 2 seconds
          setTimeout(() => {
            if (submitText) {
              submitText.textContent = {{ "products.product.add_to_cart" | t | default: "In den Warenkorb" | json }};
            }
            if (submitBtn) submitBtn.disabled = false;
          }, 2000);
          
        } else {
          const errorData = await response.json();
          throw new Error(errorData.description || 'Error adding to cart');
        }
        
      } catch (error) {
        
        // Show error state
        if (submitText) {
          submitText.hidden = false;
          submitText.textContent = 'Fehler - Bitte erneut versuchen';
        }
        if (submitLoading) submitLoading.hidden = true;
        
        // Reset after 3 seconds
        setTimeout(() => {
          if (submitText) {
            submitText.textContent = {{ "products.product.add_to_cart" | t | default: "In den Warenkorb" | json }};
          }
          if (submitBtn) submitBtn.disabled = false;
        }, 3000);
      }
    });
  } else {
  }
  
});
</script>

{% schema %}
{
  "name": "Product Page",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_dynamic_checkout",
      "label": "Show dynamic checkout button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "enable_zoom",
      "label": "Enable image zoom",
      "default": true
    }
  ],
  "presets": [
    {
      "name": "Product Page"
    }
  ]
}
{% endschema %}
