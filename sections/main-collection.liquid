{% comment %}
  MAIN COLLECTION - Full collection page with filters and product grid
  
  Features:
  - Collection banner
  - Product count
  - Sorting
  - Infinite scroll / Load more
  - Integration with collection-filters section
{% endcomment %}

{%- liquid
  assign sort_by = collection.sort_by | default: collection.default_sort_by
  assign products_per_page = section.settings.products_per_page | default: 24
-%}

{%- comment -%} Breadcrumbs {%- endcomment -%}
{% render 'breadcrumbs', type: 'collection', collection: collection %}

{%- comment -%} Collection Banner {%- endcomment -%}
{%- if section.settings.show_banner and collection.image -%}
  <div class="collection-banner">
    <img
      class="collection-banner__image"
      src="{{ collection.image | image_url: width: 1920 }}"
      srcset="{{ collection.image | image_url: width: 800 }} 800w,
              {{ collection.image | image_url: width: 1200 }} 1200w,
              {{ collection.image | image_url: width: 1920 }} 1920w"
      sizes="100vw"
      alt="{{ collection.image.alt | escape | default: collection.title }}"
      width="{{ collection.image.width }}"
      height="{{ collection.image.height }}"
      loading="eager"
      fetchpriority="high"
    >
    <div class="collection-banner__content">
      <h1 class="collection-banner__title">{{ collection.title }}</h1>
      {%- if collection.description != blank and section.settings.show_description -%}
        <div class="collection-banner__description rte">
          {{ collection.description }}
        </div>
      {%- endif -%}
    </div>
  </div>
{%- else -%}
  <div class="collection-header">
    <div class="container">
      <h1 class="collection-header__title">{{ collection.title }}</h1>
      {%- if collection.description != blank and section.settings.show_description -%}
        <div class="collection-header__description rte">
          {{ collection.description }}
        </div>
      {%- endif -%}
    </div>
  </div>
{%- endif -%}

<section class="collection-page section">
  <div class="container">
    <div class="collection-page__layout">
      
      {%- comment -%} Filters Sidebar {%- endcomment -%}
      {% section 'collection-filters' %}

      {%- comment -%} Main Content {%- endcomment -%}
      <div class="collection-page__main">
        
        {%- comment -%} Toolbar {%- endcomment -%}
        <div class="collection-toolbar hidden-mobile">
          <p class="collection-toolbar__count">
            {{ 'collections.general.product_count' | t: count: collection.products_count | default: collection.products_count | append: ' Produkte' }}
          </p>

          <div class="collection-toolbar__sort">
            <label for="SortBy" class="visually-hidden">{{ 'collections.sorting.title' | t }}</label>
            <select id="SortBy" data-sort-by class="collection-toolbar__sort-select">
              {%- for option in collection.sort_options -%}
                <option value="{{ option.value }}"{% if option.value == sort_by %} selected{% endif %}>
                  {{ option.name }}
                </option>
              {%- endfor -%}
            </select>
          </div>
        </div>

        {%- comment -%} Product Grid {%- endcomment -%}
        {%- paginate collection.products by products_per_page -%}
          {%- if collection.products.size > 0 -%}
            <div class="collection-grid" data-collection-grid>
              <div class="grid grid--2-col grid--3-col-tablet grid--4-col-desktop">
                {%- for product in collection.products -%}
                  {% render 'product-card', 
                    product: product, 
                    lazy: true, 
                    card_index: forloop.index 
                  %}
                {%- endfor -%}
              </div>
            </div>

            {%- comment -%} Pagination {%- endcomment -%}
            {%- if paginate.pages > 1 -%}
              <nav class="collection-pagination" aria-label="Pagination">
                {%- if section.settings.pagination_type == 'infinite' -%}
                  {%- comment -%} Infinite Scroll / Load More {%- endcomment -%}
                  {%- if paginate.next -%}
                    <button 
                      type="button" 
                      class="collection-pagination__load-more btn btn--secondary"
                      data-load-more
                      data-next-url="{{ paginate.next.url }}"
                    >
                      <span>{{ 'collections.general.load_more' | t | default: 'Mehr laden' }}</span>
                      <span class="spinner spinner--small" hidden></span>
                    </button>
                  {%- endif -%}
                  <p class="collection-pagination__progress">
                    {{ 'collections.general.showing' | t: current: paginate.current_offset | plus: collection.products.size, total: collection.products_count | default: 'Zeigt' | append: ' ' | append: paginate.current_offset | plus: collection.products.size | append: ' von ' | append: collection.products_count }}
                  </p>
                {%- else -%}
                  {%- comment -%} Traditional Pagination {%- endcomment -%}
                  <ul class="collection-pagination__list">
                    {%- if paginate.previous -%}
                      <li>
                        <a href="{{ paginate.previous.url }}" class="collection-pagination__link collection-pagination__link--prev" aria-label="Previous page">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"/>
                          </svg>
                        </a>
                      </li>
                    {%- endif -%}

                    {%- for part in paginate.parts -%}
                      <li>
                        {%- if part.is_link -%}
                          <a href="{{ part.url }}" class="collection-pagination__link">{{ part.title }}</a>
                        {%- else -%}
                          {%- if part.title == paginate.current_page -%}
                            <span class="collection-pagination__link collection-pagination__link--current" aria-current="page">{{ part.title }}</span>
                          {%- else -%}
                            <span class="collection-pagination__link collection-pagination__link--gap">{{ part.title }}</span>
                          {%- endif -%}
                        {%- endif -%}
                      </li>
                    {%- endfor -%}

                    {%- if paginate.next -%}
                      <li>
                        <a href="{{ paginate.next.url }}" class="collection-pagination__link collection-pagination__link--next" aria-label="Next page">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"/>
                          </svg>
                        </a>
                      </li>
                    {%- endif -%}
                  </ul>
                {%- endif -%}
              </nav>
            {%- endif -%}
          {%- else -%}
            {%- comment -%} No Products {%- endcomment -%}
            <div class="collection-empty">
              <p>{{ 'collections.general.no_matches' | t | default: 'Keine Produkte gefunden' }}</p>
              {%- if collection.filters.size > 0 -%}
                <a href="{{ collection.url }}" class="btn btn--secondary">
                  {{ 'collections.filtering.clear_all' | t | default: 'Filter zur√ºcksetzen' }}
                </a>
              {%- endif -%}
            </div>
          {%- endif -%}
        {%- endpaginate -%}
      </div>
    </div>
  </div>
</section>

{%- comment -%} Collection Schema {%- endcomment -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CollectionPage",
  "name": {{ collection.title | json }},
  "description": {{ collection.description | strip_html | truncate: 200 | json }},
  "url": {{ request.origin | append: collection.url | json }},
  {%- if collection.image -%}
  "image": {{ collection.image | image_url: width: 1200 | json }},
  {%- endif -%}
  "numberOfItems": {{ collection.products_count }}
}
</script>

<style>
  /* Banner */
  .collection-banner {
    position: relative;
    height: 300px;
    overflow: hidden;
  }

  @media (min-width: 768px) {
    .collection-banner {
      height: 400px;
    }
  }

  .collection-banner__image {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .collection-banner__content {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 2rem;
    background: rgba(0, 0, 0, 0.4);
    color: white;
  }

  .collection-banner__title {
    font-size: 2rem;
    margin: 0 0 1rem;
  }

  @media (min-width: 768px) {
    .collection-banner__title {
      font-size: 3rem;
    }
  }

  .collection-banner__description {
    max-width: 600px;
    font-size: 1rem;
    opacity: 0.9;
  }

  /* Header (no banner) */
  .collection-header {
    padding: 2rem 0;
    text-align: center;
  }

  .collection-header__title {
    font-size: 2rem;
    margin: 0 0 0.75rem;
  }

  .collection-header__description {
    max-width: 700px;
    margin: 0 auto;
    color: var(--color-text-secondary);
  }

  /* Layout */
  .collection-page__layout {
    display: flex;
    gap: 2rem;
  }

  .collection-page__main {
    flex: 1;
    min-width: 0;
  }

  /* Toolbar */
  .collection-toolbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 0;
    border-bottom: 1px solid var(--color-border);
    margin-bottom: 1.5rem;
  }

  .collection-toolbar__count {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin: 0;
  }

  .collection-toolbar__sort-select {
    padding: 0.5rem 2rem 0.5rem 0.75rem;
    font-size: 0.875rem;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") no-repeat right 0.75rem center;
    -webkit-appearance: none;
    cursor: pointer;
  }

  /* Grid */
  .collection-grid {
    margin-bottom: 2rem;
  }

  /* Pagination */
  .collection-pagination {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 2rem 0;
  }

  .collection-pagination__list {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .collection-pagination__link {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 40px;
    height: 40px;
    padding: 0 0.75rem;
    font-size: 0.875rem;
    color: var(--color-text);
    text-decoration: none;
    border: 1px solid var(--color-border);
    border-radius: var(--border-radius);
    transition: all 0.2s;
  }

  .collection-pagination__link:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .collection-pagination__link--current {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }

  .collection-pagination__link--gap {
    border: none;
    color: var(--color-text-secondary);
  }

  .collection-pagination__load-more {
    min-width: 200px;
  }

  .collection-pagination__load-more .spinner {
    margin-left: 0.5rem;
  }

  .collection-pagination__progress {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
    margin: 0;
  }

  /* Empty State */
  .collection-empty {
    text-align: center;
    padding: 4rem 2rem;
  }

  .collection-empty p {
    font-size: 1.125rem;
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Sort change
  const sortSelect = document.querySelector('[data-sort-by]');
  sortSelect?.addEventListener('change', function() {
    const url = new URL(window.location);
    url.searchParams.set('sort_by', this.value);
    window.location = url;
  });

  // Load more / Infinite scroll
  const loadMoreBtn = document.querySelector('[data-load-more]');
  const grid = document.querySelector('[data-collection-grid] .grid');
  
  if (loadMoreBtn && grid) {
    loadMoreBtn.addEventListener('click', async function() {
      const nextUrl = this.dataset.nextUrl;
      if (!nextUrl) return;

      const btnText = this.querySelector('span:first-child');
      const spinner = this.querySelector('.spinner');
      
      btnText.hidden = true;
      spinner.hidden = false;
      this.disabled = true;

      try {
        const response = await fetch(nextUrl);
        const html = await response.text();
        
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Get new products
        const newProducts = doc.querySelectorAll('[data-collection-grid] .grid > *');
        newProducts.forEach(product => {
          grid.appendChild(product.cloneNode(true));
        });

        // Update load more button
        const newLoadMore = doc.querySelector('[data-load-more]');
        if (newLoadMore) {
          this.dataset.nextUrl = newLoadMore.dataset.nextUrl;
        } else {
          this.remove();
        }

        // Update progress
        const newProgress = doc.querySelector('.collection-pagination__progress');
        const currentProgress = document.querySelector('.collection-pagination__progress');
        if (newProgress && currentProgress) {
          currentProgress.textContent = newProgress.textContent;
        }

        // Update URL without reload
        window.history.replaceState({}, '', nextUrl);

      } catch (error) {
        console.error('Error loading more products:', error);
      } finally {
        btnText.hidden = false;
        spinner.hidden = true;
        this.disabled = false;
      }
    });

    // Optional: Infinite scroll
    if (window.almliebe?.settings?.infiniteScroll) {
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && !loadMoreBtn.disabled) {
            loadMoreBtn.click();
          }
        });
      }, { rootMargin: '200px' });

      observer.observe(loadMoreBtn);
    }
  }
});
</script>

{% schema %}
{
  "name": "Main Collection",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_banner",
      "label": "Show collection banner",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_description",
      "label": "Show collection description",
      "default": true
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 12,
      "max": 48,
      "step": 4,
      "default": 24,
      "label": "Products per page"
    },
    {
      "type": "select",
      "id": "pagination_type",
      "label": "Pagination type",
      "options": [
        { "value": "traditional", "label": "Traditional pagination" },
        { "value": "infinite", "label": "Load more button" }
      ],
      "default": "infinite"
    }
  ]
}
{% endschema %}
