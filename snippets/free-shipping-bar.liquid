{% comment %}
  FREE SHIPPING BAR - Progress indicator for free shipping threshold
  
  Usage: {% render 'free-shipping-bar', cart: cart %}
  
  Features:
  - Visual progress bar
  - Dynamic messaging
  - Celebratory state when threshold reached
{% endcomment %}

{%- liquid
  assign threshold = settings.free_shipping_threshold | times: 100
  assign cart_total = cart.total_price
  assign remaining = threshold | minus: cart_total
  
  if remaining <= 0
    assign progress = 100
    assign is_complete = true
  else
    assign progress = cart_total | times: 100 | divided_by: threshold
    assign is_complete = false
  endif
  
  assign remaining_formatted = remaining | money_without_trailing_zeros
  assign threshold_formatted = settings.free_shipping_threshold | times: 100 | money_without_trailing_zeros
-%}

{%- if settings.show_free_shipping_bar and threshold > 0 -%}
  <div 
    class="free-shipping-bar{% if is_complete %} free-shipping-bar--complete{% endif %}" 
    data-free-shipping-bar
    data-threshold="{{ threshold }}"
  >
    <div class="free-shipping-bar__content">
      {%- if is_complete -%}
        <div class="free-shipping-bar__message">
          <svg class="free-shipping-bar__icon free-shipping-bar__icon--check" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          <span data-free-shipping-message>
            {{ 'cart.general.free_shipping_unlocked' | t | default: 'ðŸŽ‰ Kostenloser Versand freigeschaltet!' }}
          </span>
        </div>
      {%- else -%}
        <div class="free-shipping-bar__message">
          <svg class="free-shipping-bar__icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
            <circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
          </svg>
          <span data-free-shipping-message>
            {{ 'cart.general.shipping_remaining' | t: amount: remaining_formatted | default: 'Nur noch' | append: ' ' | append: remaining_formatted | append: ' bis zum kostenlosen Versand!' }}
          </span>
        </div>
      {%- endif -%}
    </div>
    
    <div class="free-shipping-bar__track">
      <div 
        class="free-shipping-bar__progress" 
        style="width: {{ progress }}%;"
        data-free-shipping-progress
      ></div>
    </div>
  </div>
{%- endif -%}

<style>
  .free-shipping-bar {
    padding: 0.75rem 1rem;
    background: var(--color-background);
    border-radius: var(--border-radius);
    margin-bottom: 1rem;
  }

  .free-shipping-bar--complete {
    background: rgba(46, 125, 50, 0.1);
  }

  .free-shipping-bar__content {
    margin-bottom: 0.5rem;
  }

  .free-shipping-bar__message {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .free-shipping-bar__icon {
    flex-shrink: 0;
    color: var(--color-primary);
  }

  .free-shipping-bar--complete .free-shipping-bar__icon--check {
    color: var(--color-success);
  }

  .free-shipping-bar--complete .free-shipping-bar__message {
    color: var(--color-success);
  }

  .free-shipping-bar__track {
    height: 6px;
    background: var(--color-border);
    border-radius: 3px;
    overflow: hidden;
  }

  .free-shipping-bar__progress {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-accent));
    border-radius: 3px;
    transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .free-shipping-bar--complete .free-shipping-bar__progress {
    background: var(--color-success);
  }

  /* Animation on completion */
  .free-shipping-bar--complete .free-shipping-bar__progress {
    animation: shimmer 1.5s ease-in-out;
  }

  @keyframes shimmer {
    0% {
      background-position: -100% 0;
    }
    100% {
      background-position: 100% 0;
    }
  }
</style>

<script>
  // Update free shipping bar when cart changes
  document.addEventListener('cart:updated', function() {
    updateFreeShippingBar();
  });

  async function updateFreeShippingBar() {
    const bar = document.querySelector('[data-free-shipping-bar]');
    if (!bar) return;

    const threshold = parseInt(bar.dataset.threshold);
    
    try {
      const response = await fetch('/cart.js');
      const cart = await response.json();
      
      const remaining = threshold - cart.total_price;
      const progress = remaining <= 0 ? 100 : (cart.total_price / threshold * 100);
      const isComplete = remaining <= 0;

      // Update progress bar
      const progressBar = bar.querySelector('[data-free-shipping-progress]');
      if (progressBar) {
        progressBar.style.width = `${progress}%`;
      }

      // Update message
      const message = bar.querySelector('[data-free-shipping-message]');
      if (message) {
        if (isComplete) {
          message.textContent = window.almliebe?.strings?.freeShipping || 'ðŸŽ‰ Kostenloser Versand freigeschaltet!';
        } else {
          const formatted = formatMoney(remaining);
          message.textContent = (window.almliebe?.strings?.shippingRemaining || 'Nur noch {amount} bis zum kostenlosen Versand!')
            .replace('{amount}', formatted);
        }
      }

      // Update complete state
      bar.classList.toggle('free-shipping-bar--complete', isComplete);

    } catch (error) {
      console.error('Error updating free shipping bar:', error);
    }
  }

  function formatMoney(cents) {
    return window.almliebe?.formatMoney?.(cents) || 
      new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(cents / 100);
  }
</script>
