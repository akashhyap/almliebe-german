{% comment %}
  Back In Stock Notification Drawer
  Gymshark-style slide-in from right
  
  Usage: {% render 'back-in-stock-drawer' %}
  Add this to your theme.liquid before </body>
{% endcomment %}

<div class="stock-alert-drawer" data-stock-alert-drawer>
  <div class="stock-alert-drawer__overlay" data-stock-alert-close></div>
  <div class="stock-alert-drawer__content">
    <button class="stock-alert-drawer__close" data-stock-alert-close aria-label="{{ 'accessibility.close' | t }}">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </button>
    
    <div class="stock-alert-drawer__header">
      <h2 class="stock-alert-drawer__title">{{ 'back_in_stock.title' | t | upcase }}</h2>
    </div>
    
    <div class="stock-alert-drawer__body">
      <p class="stock-alert-drawer__subtitle">{{ 'back_in_stock.select_size' | t }}</p>
      
      <div class="stock-alert-drawer__product" data-stock-alert-product>
        <div class="stock-alert-drawer__product-image">
          <img src="" alt="" data-stock-alert-image>
        </div>
        <div class="stock-alert-drawer__product-info">
          <h3 class="stock-alert-drawer__product-title" data-stock-alert-title></h3>
          <p class="stock-alert-drawer__product-variant" data-stock-alert-variant></p>
        </div>
      </div>
      
      <div class="stock-alert-drawer__sizes" data-stock-alert-sizes>
        <!-- Sizes will be populated by JavaScript -->
      </div>
      
      <form class="stock-alert-drawer__form" data-stock-alert-form>
        <input type="hidden" name="product_id" data-stock-alert-product-id>
        <input type="hidden" name="variant_id" data-stock-alert-variant-id>
        <input type="hidden" name="variant_title" data-stock-alert-variant-title>
        
        <label class="stock-alert-drawer__label">
          {{ 'back_in_stock.email_label' | t }}
        </label>
        <input 
          type="email" 
          name="email" 
          class="stock-alert-drawer__input" 
          placeholder="{{ 'back_in_stock.email_placeholder' | t }}"
          required
          data-stock-alert-email
        >
        
        <button type="submit" class="stock-alert-drawer__submit btn btn--primary btn--full">
          <span data-stock-alert-submit-text>{{ 'back_in_stock.submit' | t | upcase }}</span>
          <span class="stock-alert-drawer__submit-loading" hidden>
            <span class="spinner spinner--small"></span>
          </span>
        </button>
      </form>
      
      <div class="stock-alert-drawer__success" data-stock-alert-success hidden>
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#2f855a" stroke-width="2">
          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
          <polyline points="22 4 12 14.01 9 11.01"/>
        </svg>
        <h3>{{ 'back_in_stock.success_title' | t }}</h3>
        <p>{{ 'back_in_stock.success_text' | t }}</p>
      </div>
    </div>
  </div>
</div>

<style>
  .stock-alert-drawer {
    position: fixed;
    inset: 0;
    z-index: 1000;
    visibility: hidden;
    pointer-events: none;
  }
  
  .stock-alert-drawer.is-open {
    visibility: visible;
    pointer-events: auto;
  }
  
  .stock-alert-drawer__overlay {
    position: absolute;
    inset: 0;
    background: rgba(0, 0, 0, 0);
    transition: background 0.3s ease;
  }
  
  .stock-alert-drawer.is-open .stock-alert-drawer__overlay {
    background: rgba(0, 0, 0, 0.5);
  }
  
  .stock-alert-drawer__content {
    position: absolute;
    top: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    max-width: 480px;
    background: #ffffff;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  
  .stock-alert-drawer.is-open .stock-alert-drawer__content {
    transform: translateX(0);
  }
  
  .stock-alert-drawer__close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: transparent;
    border: none;
    cursor: pointer;
    z-index: 10;
  }
  
  .stock-alert-drawer__close:hover {
    opacity: 0.7;
  }
  
  .stock-alert-drawer__header {
    padding: 2rem 2rem 1rem;
  }
  
  .stock-alert-drawer__title {
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: 0.05em;
    margin: 0;
  }
  
  .stock-alert-drawer__body {
    padding: 0 2rem 2rem;
    flex: 1;
  }
  
  .stock-alert-drawer__subtitle {
    color: #666666;
    margin-bottom: 1rem;
  }
  
  .stock-alert-drawer__product {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: #f9f9f9;
    margin-bottom: 1.5rem;
  }
  
  .stock-alert-drawer__product-image {
    width: 80px;
    height: 100px;
    flex-shrink: 0;
  }
  
  .stock-alert-drawer__product-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .stock-alert-drawer__product-info {
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  
  .stock-alert-drawer__product-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.25rem;
  }
  
  .stock-alert-drawer__product-variant {
    color: #666666;
    font-size: 0.875rem;
    margin: 0;
  }
  
  .stock-alert-drawer__sizes {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }
  
  .stock-alert-drawer__size {
    position: relative;
  }
  
  .stock-alert-drawer__size input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }
  
  .stock-alert-drawer__size-label {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 60px;
    padding: 0.75rem 1rem;
    background: #ffffff;
    border: 1px solid #e5e5e5;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .stock-alert-drawer__size input:checked + .stock-alert-drawer__size-label {
    background: #000000;
    border-color: #000000;
    color: #ffffff;
  }
  
  .stock-alert-drawer__size-label:hover {
    border-color: #000000;
  }
  
  .stock-alert-drawer__label {
    display: block;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
    color: #333333;
  }
  
  .stock-alert-drawer__input {
    width: 100%;
    padding: 1rem;
    border: 1px solid #e5e5e5;
    background: #ffffff;
    font-size: 1rem;
    margin-bottom: 1rem;
  }
  
  .stock-alert-drawer__input:focus {
    outline: none;
    border-color: #000000;
  }
  
  .stock-alert-drawer__submit {
    width: 100%;
    padding: 1rem 2rem;
    background: #000000;
    border-radius: 9999px;
    color: #ffffff;
    border: none;
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: background 0.2s ease;
    position: relative;
  }
  
  .stock-alert-drawer__submit:hover {
    background: #333333;
  }
  
  .stock-alert-drawer__submit-loading {
    display: none;
  }
  
  .stock-alert-drawer__submit-loading:not([hidden]) {
    display: inline-flex;
    align-items: center;
    justify-content: center;
  }
  
  .stock-alert-drawer__submit .spinner--small {
    width: 18px;
    height: 18px;
    border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  .stock-alert-drawer__success {
    text-align: center;
    padding: 2rem 0;
  }
  
  .stock-alert-drawer__success svg {
    margin-bottom: 1rem;
  }
  
  .stock-alert-drawer__success h3 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
  }
  
  .stock-alert-drawer__success p {
    color: #666666;
  }

  /* Mobile adjustments */
  @media (max-width: 480px) {
    .stock-alert-drawer__content {
      max-width: 100%;
    }
    
    .stock-alert-drawer__header,
    .stock-alert-drawer__body {
      padding-left: 1.5rem;
      padding-right: 1.5rem;
    }
  }
</style>

<script>
(function() {
  const drawer = document.querySelector('[data-stock-alert-drawer]');
  if (!drawer) return;
  
  const closeButtons = drawer.querySelectorAll('[data-stock-alert-close]');
  const form = drawer.querySelector('[data-stock-alert-form]');
  const successMessage = drawer.querySelector('[data-stock-alert-success]');
  const productImage = drawer.querySelector('[data-stock-alert-image]');
  const productTitle = drawer.querySelector('[data-stock-alert-title]');
  const productVariant = drawer.querySelector('[data-stock-alert-variant]');
  const sizesContainer = drawer.querySelector('[data-stock-alert-sizes]');
  const variantIdInput = drawer.querySelector('[data-stock-alert-variant-id]');
  const variantTitleInput = drawer.querySelector('[data-stock-alert-variant-title]');
  const productIdInput = drawer.querySelector('[data-stock-alert-product-id]');
  
  let currentProduct = null;
  
  // Open drawer
  window.openStockAlertDrawer = function(productData) {
    currentProduct = productData;
    
    // Set product info
    if (productImage) productImage.src = productData.image;
    if (productTitle) productTitle.textContent = productData.title;
    if (productVariant) productVariant.textContent = productData.color || '';
    if (productIdInput) productIdInput.value = productData.productId;
    
    // Build size buttons for out-of-stock variants only
    if (sizesContainer && productData.unavailableVariants) {
      sizesContainer.innerHTML = productData.unavailableVariants.map((variant, index) => `
        <label class="stock-alert-drawer__size">
          <input 
            type="radio" 
            name="stock_alert_size" 
            value="${variant.id}"
            data-variant-title="${variant.title}"
            ${index === 0 ? 'checked' : ''}
          >
          <span class="stock-alert-drawer__size-label">${variant.option}</span>
        </label>
      `).join('');
      
      // Set initial variant
      const firstVariant = productData.unavailableVariants[0];
      if (firstVariant) {
        variantIdInput.value = firstVariant.id;
        variantTitleInput.value = firstVariant.title;
      }
      
      // Handle size selection
      sizesContainer.querySelectorAll('input').forEach(input => {
        input.addEventListener('change', function() {
          variantIdInput.value = this.value;
          variantTitleInput.value = this.dataset.variantTitle;
        });
      });
    }
    
    // Reset form state
    form.reset();
    form.hidden = false;
    successMessage.hidden = true;
    
    // Open drawer
    drawer.classList.add('is-open');
    document.body.style.overflow = 'hidden';
  };
  
  // Close drawer
  function closeDrawer() {
    drawer.classList.remove('is-open');
    document.body.style.overflow = '';
  }
  
  closeButtons.forEach(btn => {
    btn.addEventListener('click', closeDrawer);
  });
  
  // Close on escape key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && drawer.classList.contains('is-open')) {
      closeDrawer();
    }
  });
  
  // Handle form submission
  form?.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = form.querySelector('.stock-alert-drawer__submit');
    const submitText = form.querySelector('[data-stock-alert-submit-text]');
    const submitLoading = form.querySelector('.stock-alert-drawer__submit-loading');
    const emailInput = form.querySelector('[data-stock-alert-email]');
    
    // Show loading
    submitText.hidden = true;
    submitLoading.hidden = false;
    submitBtn.disabled = true;
    
    const formData = {
      email: emailInput.value,
      product_id: productIdInput.value,
      variant_id: variantIdInput.value,
      variant_title: variantTitleInput.value,
      product_title: productTitle.textContent
    };
    
    try {
      // Option 1: If using Klaviyo Back in Stock
      if (window._learnq) {
        window._learnq.push(['track', 'Back In Stock Subscribe', {
          '$email': formData.email,
          'ProductId': formData.product_id,
          'VariantId': formData.variant_id,
          'ProductTitle': formData.product_title,
          'VariantTitle': formData.variant_title
        }]);
      }
      
      // Option 2: Send to custom endpoint (if you have one set up)
      // await fetch('/apps/back-in-stock/subscribe', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify(formData)
      // });
      
      // Option 3: Store in localStorage for demo (replace with real endpoint)
      const subscriptions = JSON.parse(localStorage.getItem('stockAlerts') || '[]');
      subscriptions.push({...formData, timestamp: Date.now()});
      localStorage.setItem('stockAlerts', JSON.stringify(subscriptions));
      
      // Show success
      form.hidden = true;
      successMessage.hidden = false;
      
      // Close drawer after 3 seconds
      setTimeout(closeDrawer, 3000);
      
    } catch (error) {
      console.error('Stock alert error:', error);
      alert(window.almliebe?.strings?.backInStockError || 'Es ist ein Fehler aufgetreten. Bitte versuchen Sie es erneut.');
    } finally {
      submitText.hidden = false;
      submitLoading.hidden = true;
      submitBtn.disabled = false;
    }
  });
})();
</script>
