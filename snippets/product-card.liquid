{% comment %}
  PRODUCT CARD - Gymshark-inspired with mobile size overlay
  
  Usage:
  {% render 'product-card', product: product, lazy: true, show_vendor: false %}
  
  Parameters:
  - product: Product object (required)
  - lazy: boolean - lazy load image (default: true)
  - show_vendor: boolean - show vendor/brand (default: settings.show_vendor)
  - show_quick_add: boolean - show quick add button (default: settings.show_quick_add)
  - card_index: number - for lazy loading first 4-8 cards eagerly
{% endcomment %}

{%- liquid
  assign lazy = lazy | default: true
  assign show_vendor = show_vendor | default: settings.show_vendor
  assign show_quick_add = show_quick_add | default: settings.show_quick_add
  
  # Eager load first 4 cards on mobile, first 8 on desktop
  if card_index != blank and card_index < 8
    assign lazy = false
  endif
  
  # Check if product has size options
  assign has_size_option = false
  assign size_option_index = nil
  for option in product.options_with_values
    assign option_name_lower = option.name | downcase
    if option_name_lower == 'size' or option_name_lower == 'größe'
      assign has_size_option = true
      assign size_option_index = forloop.index0
      assign size_option = option
      break
    endif
  endfor
  
  # Get available sizes
  assign available_sizes = ''
  if has_size_option
    for variant in product.variants
      if variant.available
        assign size_value = variant.options[size_option_index]
        unless available_sizes contains size_value
          if available_sizes != ''
            assign available_sizes = available_sizes | append: ','
          endif
          assign available_sizes = available_sizes | append: size_value
        endunless
      endif
    endfor
  endif
  
  # Badge logic
  assign show_sale_badge = false
  assign show_new_badge = false
  assign show_soldout_badge = false
  assign show_lowstock_badge = false
  
  if product.available == false
    assign show_soldout_badge = true
  elsif product.compare_at_price > product.price
    assign show_sale_badge = true
  elsif product.created_at > 'now' | date: '%s' | minus: 2592000 | date: '%Y-%m-%d'
    assign show_new_badge = true
  endif
  
  # Check low stock
  if settings.show_stock_level and product.available
    assign total_inventory = 0
    for variant in product.variants
      if variant.inventory_management and variant.inventory_quantity > 0
        assign total_inventory = total_inventory | plus: variant.inventory_quantity
      endif
    endfor
    if total_inventory > 0 and total_inventory <= settings.low_stock_threshold
      assign show_lowstock_badge = true
    endif
  endif
  
  # Calculate sale percentage
  if show_sale_badge
    assign savings = product.compare_at_price | minus: product.price
    assign savings_percent = savings | times: 100.0 | divided_by: product.compare_at_price | round
  endif
-%}

<div class="product-card" data-product-card data-product-id="{{ product.id }}">
  {%- comment -%} Image Container {%- endcomment -%}
  <div class="product-card__media">
    <a href="{{ product.url }}" class="product-card__link" aria-label="{{ product.title | escape }}">
      {%- if product.featured_media -%}
        <img
          class="product-card__image product-card__image--primary"
          src="{{ product.featured_media | image_url: width: 600 }}"
          srcset="{{ product.featured_media | image_url: width: 300 }} 300w,
                  {{ product.featured_media | image_url: width: 450 }} 450w,
                  {{ product.featured_media | image_url: width: 600 }} 600w,
                  {{ product.featured_media | image_url: width: 900 }} 900w"
          sizes="(min-width: 1200px) 300px, (min-width: 768px) 33vw, 50vw"
          alt="{{ product.featured_media.alt | escape | default: product.title }}"
          width="600"
          height="{{ 600 | divided_by: product.featured_media.aspect_ratio | round }}"
          {% if lazy %}loading="lazy" decoding="async"{% else %}fetchpriority="high"{% endif %}
        >
        
        {%- comment -%} Secondary image on hover (desktop) {%- endcomment -%}
        {%- if settings.show_secondary_image and product.media.size > 1 -%}
          <img
            class="product-card__image product-card__image--secondary"
            src="{{ product.media[1] | image_url: width: 600 }}"
            srcset="{{ product.media[1] | image_url: width: 300 }} 300w,
                    {{ product.media[1] | image_url: width: 450 }} 450w,
                    {{ product.media[1] | image_url: width: 600 }} 600w"
            sizes="(min-width: 1200px) 300px, (min-width: 768px) 33vw, 50vw"
            alt="{{ product.media[1].alt | escape | default: product.title }}"
            width="600"
            height="{{ 600 | divided_by: product.media[1].aspect_ratio | round }}"
            loading="lazy"
            decoding="async"
          >
        {%- endif -%}
      {%- else -%}
        <div class="product-card__placeholder">
          {{ 'product-1' | placeholder_svg_tag: 'product-card__placeholder-svg' }}
        </div>
      {%- endif -%}
    </a>

    {%- comment -%} Badges {%- endcomment -%}
    <div class="product-card__badges">
      {%- if show_soldout_badge -%}
        <span class="badge badge--sold-out">{{ 'products.product.sold_out' | t }}</span>
      {%- elsif show_sale_badge -%}
        <span class="badge badge--sale">-{{ savings_percent }}%</span>
      {%- elsif show_new_badge -%}
        <span class="badge badge--new">{{ 'products.product.new' | t | default: 'Neu' }}</span>
      {%- endif -%}
      
      {%- if show_lowstock_badge and show_soldout_badge == false -%}
        <span class="badge badge--low-stock">{{ 'products.product.low_stock' | t | default: 'Fast ausverkauft' }}</span>
      {%- endif -%}
    </div>

    {%- comment -%} GYMSHARK PATTERN: Mobile Size Overlay {%- endcomment -%}
    {%- if has_size_option and product.available -%}
      <div class="product-card__sizes" data-size-overlay>
        <div class="product-card__sizes-inner">
          {%- for value in size_option.values -%}
            {%- liquid
              assign size_available = false
              for variant in product.variants
                if variant.options[size_option_index] == value and variant.available
                  assign size_available = true
                  break
                endif
              endfor
            -%}
            <button 
              type="button"
              class="product-card__size{% unless size_available %} product-card__size--unavailable{% endunless %}"
              data-size-button
              data-size-value="{{ value | escape }}"
              {% unless size_available %}disabled aria-disabled="true"{% endunless %}
              aria-label="{{ 'products.product.add_size' | t: size: value | default: 'Größe' | append: ' ' | append: value | append: ' hinzufügen' }}"
            >
              {{ value }}
            </button>
          {%- endfor -%}
        </div>
      </div>
    {%- endif -%}

    {%- comment -%} Quick Add Button (Desktop) {%- endcomment -%}
    {%- if show_quick_add and product.available -%}
      <div class="product-card__quick-add hidden-mobile">
        {%- if product.has_only_default_variant -%}
          <form method="post" action="/cart/add" class="product-card__form">
            <input type="hidden" name="id" value="{{ product.first_available_variant.id }}">
            <input type="hidden" name="quantity" value="1">
            <button type="submit" class="product-card__quick-add-btn" data-add-to-cart>
              {{ 'products.product.add_to_cart' | t }}
            </button>
          </form>
        {%- else -%}
          <a href="{{ product.url }}" class="product-card__quick-add-btn">
            {{ 'products.product.choose_options' | t | default: 'Optionen wählen' }}
          </a>
        {%- endif -%}
      </div>
    {%- endif -%}

    {%- comment -%} Wishlist Button {%- endcomment -%}
    <button 
      type="button" 
      class="product-card__wishlist" 
      data-wishlist-toggle 
      data-product-id="{{ product.id }}"
      aria-label="{{ 'products.product.add_to_wishlist' | t | default: 'Zur Wunschliste hinzufügen' }}"
    >
      <svg class="product-card__wishlist-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
      </svg>
    </button>
  </div>

  {%- comment -%} Product Info {%- endcomment -%}
  <div class="product-card__info">
    {%- if show_vendor and product.vendor != blank -%}
      <p class="product-card__vendor">{{ product.vendor }}</p>
    {%- endif -%}
    
    <h3 class="product-card__title">
      <a href="{{ product.url }}">{{ product.title }}</a>
    </h3>

    <div class="product-card__price">
      {%- if product.available -%}
        {%- if product.compare_at_price > product.price -%}
          <span class="price__sale">{{ product.price | money }}</span>
          <span class="price__compare">{{ product.compare_at_price | money }}</span>
        {%- else -%}
          <span class="price__regular">{{ product.price | money }}</span>
        {%- endif -%}
        
        {%- if settings.show_vat_included -%}
          <span class="price__note">{{ 'products.product.vat_included' | t | default: 'inkl. MwSt.' }}</span>
        {%- endif -%}
      {%- else -%}
        <span class="price__soldout">{{ 'products.product.sold_out' | t }}</span>
      {%- endif -%}
    </div>

    {%- comment -%} Size availability text (mobile) {%- endcomment -%}
    {%- if has_size_option and available_sizes != '' -%}
      <p class="product-card__available-sizes hidden-desktop">
        {{ 'products.product.sizes_available' | t | default: 'Größen' }}: {{ available_sizes | replace: ',', ', ' }}
      </p>
    {%- endif -%}
  </div>
</div>

<style>
  .product-card {
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .product-card__media {
    position: relative;
    overflow: hidden;
    border-radius: var(--border-radius);
    background: var(--color-background-secondary);
    aspect-ratio: 3/4;
  }

  .product-card__link {
    display: block;
    width: 100%;
    height: 100%;
  }

  .product-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s ease, transform 0.4s ease;
  }

  .product-card__image--secondary {
    position: absolute;
    inset: 0;
    opacity: 0;
  }

  @media (min-width: 1024px) {
    .product-card:hover .product-card__image--primary {
      opacity: 0;
    }
    
    .product-card:hover .product-card__image--secondary {
      opacity: 1;
    }
    
    .product-card:hover .product-card__image {
      transform: scale(1.03);
    }
  }

  .product-card__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-background);
  }

  .product-card__placeholder-svg {
    width: 60%;
    height: auto;
    fill: var(--color-border);
  }

  /* Badges */
  .product-card__badges {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    z-index: 2;
  }

  .product-card__badges .badge {
    font-size: 0.6875rem;
    padding: 0.25rem 0.625rem;
  }

  .badge--low-stock {
    background: var(--color-accent);
    color: var(--color-text);
  }

  /* GYMSHARK SIZE OVERLAY - Mobile */
  .product-card__sizes {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.97);
    backdrop-filter: blur(8px);
    padding: 0.75rem;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 5;
  }

  .product-card__sizes-inner {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    justify-content: center;
  }

  .product-card__size {
    min-width: 2.5rem;
    height: 2.25rem;
    padding: 0 0.5rem;
    font-size: 0.75rem;
    font-weight: 600;
    background: white;
    border: 1px solid var(--color-border);
    border-radius: calc(var(--border-radius) / 2);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .product-card__size:hover:not(:disabled) {
    border-color: var(--color-primary);
    background: var(--color-primary);
    color: white;
  }

  .product-card__size--unavailable {
    opacity: 0.4;
    text-decoration: line-through;
    cursor: not-allowed;
  }

  /* Show size overlay on mobile touch/hold */
  @media (max-width: 1023px) {
    .product-card:active .product-card__sizes,
    .product-card:focus-within .product-card__sizes,
    .product-card.is-touched .product-card__sizes {
      transform: translateY(0);
    }
  }

  /* Hide size overlay on desktop, show on hover if enabled */
  @media (min-width: 1024px) {
    .product-card__sizes {
      display: none;
    }
    
    /* Or show on hover with setting */
    .product-card:hover .product-card__sizes {
      /* transform: translateY(0); */
    }
  }

  /* Quick Add Button */
  .product-card__quick-add {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.75rem;
    background: rgba(255, 255, 255, 0.97);
    backdrop-filter: blur(8px);
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 4;
  }

  @media (min-width: 1024px) {
    .product-card:hover .product-card__quick-add {
      transform: translateY(0);
    }
  }

  .product-card__quick-add-btn {
    width: 100%;
    padding: 0.75rem 1rem;
    font-size: 0.8125rem;
    font-weight: 600;
    text-align: center;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: white;
    background: var(--color-primary);
    border: none;
    border-radius: calc(var(--border-radius) / 2);
    cursor: pointer;
    transition: background 0.2s ease;
    text-decoration: none;
    display: block;
  }

  .product-card__quick-add-btn:hover {
    background: var(--color-secondary);
  }

  /* Wishlist Button */
  .product-card__wishlist {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    opacity: 0;
    transform: scale(0.8);
    transition: all 0.2s ease;
    z-index: 3;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .product-card:hover .product-card__wishlist {
    opacity: 1;
    transform: scale(1);
  }

  .product-card__wishlist:hover {
    background: var(--color-primary);
    color: white;
  }

  .product-card__wishlist.is-active {
    opacity: 1;
    transform: scale(1);
  }

  .product-card__wishlist.is-active .product-card__wishlist-icon {
    fill: var(--color-sale);
    stroke: var(--color-sale);
  }

  /* Product Info */
  .product-card__info {
    padding: 0.875rem 0.25rem 0;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .product-card__vendor {
    font-size: 0.6875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--color-text-secondary);
    margin: 0;
  }

  .product-card__title {
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.4;
    margin: 0;
  }

  .product-card__title a {
    color: var(--color-text);
    text-decoration: none;
  }

  .product-card__title a:hover {
    color: var(--color-primary);
  }

  .product-card__price {
    display: flex;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-top: 0.25rem;
  }

  .product-card__price .price__regular,
  .product-card__price .price__sale {
    font-size: 0.9375rem;
    font-weight: 600;
  }

  .product-card__price .price__sale {
    color: var(--color-sale);
  }

  .product-card__price .price__compare {
    font-size: 0.8125rem;
    font-weight: 400;
    color: var(--color-text-secondary);
    text-decoration: line-through;
  }

  .product-card__price .price__note {
    font-size: 0.6875rem;
    color: var(--color-text-secondary);
    width: 100%;
  }

  .product-card__price .price__soldout {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-secondary);
  }

  .product-card__available-sizes {
    font-size: 0.6875rem;
    color: var(--color-text-secondary);
    margin: 0.25rem 0 0;
  }
</style>

<script>
  // Mobile touch handling for size overlay
  document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('[data-product-card]');
    
    cards.forEach(card => {
      let touchTimer;
      
      card.addEventListener('touchstart', function(e) {
        touchTimer = setTimeout(() => {
          card.classList.add('is-touched');
        }, 200);
      });
      
      card.addEventListener('touchend', function() {
        clearTimeout(touchTimer);
        setTimeout(() => {
          card.classList.remove('is-touched');
        }, 2000);
      });
      
      card.addEventListener('touchmove', function() {
        clearTimeout(touchTimer);
        card.classList.remove('is-touched');
      });
    });
    
    // Quick add from size button
    document.querySelectorAll('[data-size-button]').forEach(btn => {
      btn.addEventListener('click', async function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        const card = btn.closest('[data-product-card]');
        const productId = card.dataset.productId;
        const sizeValue = btn.dataset.sizeValue;
        
        // Find variant with this size
        try {
          const response = await fetch(`/products/${productId}.js`);
          const product = await response.json();
          
          const variant = product.variants.find(v => 
            v.available && v.options.includes(sizeValue)
          );
          
          if (variant) {
            // Add to cart
            const addResponse = await fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                id: variant.id,
                quantity: 1
              })
            });
            
            if (addResponse.ok) {
              window.almliebe?.showToast(window.almliebe?.strings?.itemAdded || 'Artikel hinzugefügt');
              // Trigger cart update event
              document.dispatchEvent(new CustomEvent('cart:updated'));
            }
          }
        } catch (error) {
          console.error('Error adding to cart:', error);
        }
      });
    });
  });
</script>
