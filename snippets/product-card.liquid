{% comment %}
  PRODUCT CARD - Gymshark-inspired mobile size overlay pattern
  
  Usage: {% render 'product-card', product: product, lazy: true %}
  
  Features:
  - Mobile: Touch-and-hold reveals size availability overlay
  - Desktop: Secondary image hover + Quick Add
  - Wishlist toggle button
  - Sale/New/Low Stock badges
  - Color swatch dots (if variants by color)
  
  FIXED: Date comparison for "new" badge now uses proper Liquid syntax
{% endcomment %}

{%- liquid
  # Defaults
  assign lazy = lazy | default: true
  assign show_vendor = show_vendor | default: settings.show_vendor
  assign show_secondary_image = show_secondary_image | default: settings.show_secondary_image
  assign card_index = card_index | default: forloop.index
  
  # Image handling
  assign featured_image = product.featured_image
  assign secondary_image = nil
  if show_secondary_image and product.images.size > 1
    assign secondary_image = product.images[1]
  endif
  
  # Price calculations
  assign current_variant = product.selected_or_first_available_variant
  assign compare_price = current_variant.compare_at_price
  assign price = current_variant.price
  assign on_sale = false
  if compare_price > price
    assign on_sale = true
    assign savings_percent = compare_price | minus: price | times: 100.0 | divided_by: compare_price | round
  endif
  
  # Availability
  assign available = product.available
  
  # Badge logic - FIXED date comparison
  assign show_sale_badge = false
  assign show_new_badge = false
  assign show_soldout_badge = false
  assign show_lowstock_badge = false
  
  if product.available == false
    assign show_soldout_badge = true
  elsif product.compare_at_price > product.price
    assign show_sale_badge = true
  else
    # Check if product is "new" (created within last 30 days)
    assign now_timestamp = 'now' | date: '%s' | plus: 0
    assign product_timestamp = product.created_at | date: '%s' | plus: 0
    assign age_seconds = now_timestamp | minus: product_timestamp
    assign thirty_days = 2592000
    if age_seconds < thirty_days
      assign show_new_badge = true
    endif
  endif
  
  # Check low stock
  if settings.show_stock_level and product.available
    assign total_inventory = 0
    for variant in product.variants
      if variant.inventory_management and variant.inventory_quantity > 0
        assign total_inventory = total_inventory | plus: variant.inventory_quantity
      endif
    endfor
    if total_inventory > 0 and total_inventory <= settings.low_stock_threshold
      assign show_lowstock_badge = true
    endif
  endif
  
  # Color variants for swatches
  assign color_option_index = nil
  for option in product.options_with_values
    assign option_name_lower = option.name | downcase
    if option_name_lower == 'color' or option_name_lower == 'colour' or option_name_lower == 'farbe'
      assign color_option_index = forloop.index0
      break
    endif
  endfor
  
  # Size variants for mobile overlay
  assign size_option_index = nil
  for option in product.options_with_values
    assign option_name_lower = option.name | downcase
    if option_name_lower == 'size' or option_name_lower == 'größe' or option_name_lower == 'groesse'
      assign size_option_index = forloop.index0
      break
    endif
  endfor
-%}

<div 
  class="product-card{% if available == false %} product-card--sold-out{% endif %}" 
  data-product-card 
  data-product-id="{{ product.id }}"
  data-product-url="{{ product.url }}"
>
  {%- comment -%} Image Container {%- endcomment -%}
  <div class="product-card__media">
    <a href="{{ product.url }}" class="product-card__link" aria-label="{{ product.title | escape }}">
      {%- comment -%} Primary Image {%- endcomment -%}
      {%- if featured_image -%}
        <img
          class="product-card__image product-card__image--primary"
          src="{{ featured_image | image_url: width: 600 }}"
          srcset="{{ featured_image | image_url: width: 300 }} 300w,
                  {{ featured_image | image_url: width: 450 }} 450w,
                  {{ featured_image | image_url: width: 600 }} 600w,
                  {{ featured_image | image_url: width: 900 }} 900w"
          sizes="(min-width: 1200px) 300px, (min-width: 768px) 33vw, 50vw"
          alt="{{ featured_image.alt | escape | default: product.title }}"
          width="600"
          height="800"
          {% if lazy and card_index > 8 %}loading="lazy"{% else %}loading="eager" fetchpriority="high"{% endif %}
        >
      {%- else -%}
        <div class="product-card__placeholder">
          {{ 'product-1' | placeholder_svg_tag: 'product-card__placeholder-svg' }}
        </div>
      {%- endif -%}
      
      {%- comment -%} Secondary Image (Desktop Hover) {%- endcomment -%}
      {%- if secondary_image -%}
        <img
          class="product-card__image product-card__image--secondary"
          src="{{ secondary_image | image_url: width: 600 }}"
          srcset="{{ secondary_image | image_url: width: 300 }} 300w,
                  {{ secondary_image | image_url: width: 600 }} 600w"
          sizes="(min-width: 1200px) 300px, (min-width: 768px) 33vw, 50vw"
          alt="{{ secondary_image.alt | escape | default: product.title }}"
          width="600"
          height="800"
          loading="lazy"
        >
      {%- endif -%}
    </a>
    
    {%- comment -%} Badges {%- endcomment -%}
    <div class="product-card__badges">
      {%- if show_soldout_badge -%}
        <span class="badge badge--soldout">{{ 'products.product.sold_out' | t | default: 'Ausverkauft' }}</span>
      {%- elsif show_sale_badge -%}
        <span class="badge badge--sale">-{{ savings_percent }}%</span>
      {%- elsif show_new_badge -%}
        <span class="badge badge--new">{{ 'products.product.new' | t | default: 'Neu' }}</span>
      {%- endif -%}
      
      {%- if show_lowstock_badge and show_soldout_badge == false -%}
        <span class="badge badge--lowstock">{{ 'products.product.low_stock' | t | default: 'Nur noch wenige' }}</span>
      {%- endif -%}
    </div>
    
    {%- comment -%} Wishlist Button {%- endcomment -%}
    <button 
      type="button" 
      class="product-card__wishlist"
      data-wishlist-toggle="{{ product.id }}"
      aria-label="{{ 'products.product.add_to_wishlist' | t | default: 'Zur Wunschliste hinzufügen' }}"
    >
      <svg class="icon-heart" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
      </svg>
    </button>
    
    {%- comment -%} Quick Add Button (Desktop) {%- endcomment -%}
    {%- if available -%}
      <button 
        type="button"
        class="product-card__quick-add hidden-mobile"
        data-quick-add="{{ product.id }}"
        {% if product.has_only_default_variant %}
          data-variant-id="{{ product.first_available_variant.id }}"
        {% endif %}
      >
        {%- if product.has_only_default_variant -%}
          {{ 'products.product.add_to_cart' | t | default: 'In den Warenkorb' }}
        {%- else -%}
          {{ 'products.product.choose_options' | t | default: 'Optionen wählen' }}
        {%- endif -%}
      </button>
    {%- endif -%}
    
    {%- comment -%} Mobile Size Overlay (Gymshark Pattern) {%- endcomment -%}
    {%- if size_option_index != nil and available -%}
      <div class="product-card__size-overlay" data-size-overlay>
        <div class="product-card__size-overlay-inner">
          <p class="product-card__size-overlay-title">{{ 'products.product.select_size' | t | default: 'Größe wählen' }}</p>
          <div class="product-card__size-buttons">
            {%- for variant in product.variants -%}
              {%- assign size_value = variant.options[size_option_index] -%}
              {%- unless previous_size == size_value -%}
                <button 
                  type="button"
                  class="product-card__size-btn{% unless variant.available %} product-card__size-btn--unavailable{% endunless %}"
                  data-size-add="{{ variant.id }}"
                  {% unless variant.available %}disabled{% endunless %}
                  aria-label="{{ size_value }}{% unless variant.available %} - {{ 'products.product.sold_out' | t | default: 'Ausverkauft' }}{% endunless %}"
                >
                  {{ size_value }}
                </button>
                {%- assign previous_size = size_value -%}
              {%- endunless -%}
            {%- endfor -%}
          </div>
        </div>
      </div>
    {%- endif -%}
  </div>

  {%- comment -%} Product Info {%- endcomment -%}
  <div class="product-card__info">
    {%- if show_vendor and product.vendor != blank -%}
      <p class="product-card__vendor">{{ product.vendor }}</p>
    {%- endif -%}
    
    <h3 class="product-card__title">
      <a href="{{ product.url }}">{{ product.title }}</a>
    </h3>
    
    {%- comment -%} Color Swatches {%- endcomment -%}
    {%- if color_option_index != nil -%}
      <div class="product-card__colors">
        {%- assign displayed_colors = '' -%}
        {%- for variant in product.variants limit: 5 -%}
          {%- assign color_value = variant.options[color_option_index] -%}
          {%- unless displayed_colors contains color_value -%}
            <span 
              class="product-card__color-swatch" 
              style="background-color: {{ color_value | handle | replace: '-', '' }};"
              title="{{ color_value }}"
            ></span>
            {%- assign displayed_colors = displayed_colors | append: color_value | append: ',' -%}
          {%- endunless -%}
        {%- endfor -%}
        {%- if product.variants.size > 5 -%}
          <span class="product-card__color-more">+{{ product.variants.size | minus: 5 }}</span>
        {%- endif -%}
      </div>
    {%- endif -%}
    
    {%- comment -%} Price {%- endcomment -%}
    <div class="product-card__price">
      {%- if on_sale -%}
        <span class="price__sale">{{ price | money }}</span>
        <span class="price__compare">{{ compare_price | money }}</span>
      {%- else -%}
        <span class="price__regular">{{ price | money }}</span>
      {%- endif -%}
      
      {%- if settings.show_vat_included -%}
        <span class="price__vat">{{ 'products.product.vat_included' | t | default: 'inkl. MwSt.' }}</span>
      {%- endif -%}
    </div>
    
    {%- comment -%} Reviews placeholder for Judge.me {%- endcomment -%}
    <div class="product-card__reviews">
      <span class="jdgm-prev-badge" data-id="{{ product.id }}"></span>
    </div>
  </div>
</div>

<style>
  .product-card {
    position: relative;
    display: flex;
    flex-direction: column;
  }

  .product-card__media {
    position: relative;
    aspect-ratio: 3 / 4;
    overflow: hidden;
    border-radius: var(--border-radius);
    background: var(--color-background);
  }

  .product-card__link {
    display: block;
    height: 100%;
  }

  .product-card__image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: opacity 0.3s;
  }

  .product-card__image--secondary {
    opacity: 0;
  }

  @media (hover: hover) {
    .product-card:hover .product-card__image--secondary {
      opacity: 1;
    }
  }

  .product-card__placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-background);
  }

  .product-card__placeholder-svg {
    width: 60%;
    height: 60%;
    opacity: 0.3;
  }

  /* Badges */
  .product-card__badges {
    position: absolute;
    top: 0.75rem;
    left: 0.75rem;
    display: flex;
    flex-direction: column;
    gap: 0.375rem;
    z-index: 2;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.625rem;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-radius: 2px;
  }

  .badge--sale {
    background: var(--color-sale, #c53030);
    color: white;
  }

  .badge--new {
    background: var(--color-primary, #000000);
    color: white;
  }

  .badge--soldout {
    background: #666666;
    color: white;
  }

  .badge--lowstock {
    background: #f5f5f5;
    color: #1a1a1a;
    border: 1px solid #e5e5e5;
  }

  /* Wishlist Button */
  .product-card__wishlist {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    opacity: 0;
    transform: scale(0.8);
    transition: opacity 0.2s, transform 0.2s;
    z-index: 2;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .product-card:hover .product-card__wishlist,
  .product-card__wishlist.is-active {
    opacity: 1;
    transform: scale(1);
  }

  .product-card__wishlist.is-active .icon-heart {
    fill: var(--color-sale, #c53030);
    stroke: var(--color-sale, #c53030);
  }

  /* Quick Add (Desktop) */
  .product-card__quick-add {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.875rem;
    font-size: 0.8125rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: white;
    background: #000000;
    border: none;
    cursor: pointer;
    transform: translateY(100%);
    transition: transform 0.3s, background 0.2s;
    z-index: 3;
  }

  @media (hover: hover) {
    .product-card:hover .product-card__quick-add {
      transform: translateY(0);
    }
  }

  .product-card__quick-add:hover {
    background: #333333;
  }

  /* Mobile Size Overlay (Gymshark Pattern) */
  .product-card__size-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 4;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
    border-radius: var(--border-radius) var(--border-radius) 0 0;
  }

  .product-card.is-touched .product-card__size-overlay {
    transform: translateY(0);
  }

  .product-card__size-overlay-inner {
    padding: 1rem;
  }

  .product-card__size-overlay-title {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 0.75rem;
    color: var(--color-text-secondary);
  }

  .product-card__size-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .product-card__size-btn {
    min-width: 44px;
    padding: 0.5rem 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    background: var(--color-background);
    border: 1px solid var(--color-border);
    border-radius: calc(var(--border-radius) / 2);
    cursor: pointer;
    transition: all 0.2s;
  }

  .product-card__size-btn:hover:not(:disabled) {
    border-color: #000000;
    background: #000000;
    color: white;
  }

  .product-card__size-btn--unavailable {
    opacity: 0.4;
    text-decoration: line-through;
    cursor: not-allowed;
  }

  /* Product Info */
  .product-card__info {
    padding: 0.875rem 0 0;
  }

  .product-card__vendor {
    font-size: 0.6875rem;
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin: 0 0 0.25rem;
  }

  .product-card__title {
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.3;
    margin: 0 0 0.375rem;
  }

  .product-card__title a {
    color: inherit;
    text-decoration: none;
  }

  .product-card__title a:hover {
    color: #666666;
  }

  /* Color Swatches */
  .product-card__colors {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    margin-bottom: 0.5rem;
  }

  .product-card__color-swatch {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    border: 1px solid rgba(0,0,0,0.1);
  }

  .product-card__color-more {
    font-size: 0.6875rem;
    color: var(--color-text-secondary);
  }

  /* Price */
  .product-card__price {
    display: flex;
    align-items: baseline;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .price__regular,
  .price__sale {
    font-size: 0.9375rem;
    font-weight: 600;
  }

  .price__sale {
    color: var(--color-sale, #c53030);
  }

  .price__compare {
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    text-decoration: line-through;
  }

  .price__vat {
    font-size: 0.6875rem;
    color: var(--color-text-secondary);
    width: 100%;
  }

  /* Reviews */
  .product-card__reviews {
    margin-top: 0.375rem;
    min-height: 20px;
  }

  /* Sold Out State */
  .product-card--sold-out .product-card__media::after {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,0.5);
    pointer-events: none;
  }

  /* Mobile utilities */
  @media (max-width: 767px) {
    .hidden-mobile {
      display: none !important;
    }

    .product-card__wishlist {
      opacity: 1;
      transform: scale(1);
    }
  }

  @media (min-width: 768px) {
    .hidden-desktop {
      display: none !important;
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Mobile touch handling for size overlay
  if ('ontouchstart' in window) {
    let touchTimer;
    
    document.addEventListener('touchstart', function(e) {
      const card = e.target.closest('[data-product-card]');
      if (!card) return;
      
      const overlay = card.querySelector('[data-size-overlay]');
      if (!overlay) return;
      
      touchTimer = setTimeout(() => {
        card.classList.add('is-touched');
      }, 200);
    });
    
    document.addEventListener('touchend', function() {
      clearTimeout(touchTimer);
    });
    
    document.addEventListener('touchmove', function() {
      clearTimeout(touchTimer);
    });
    
    // Close overlay when tapping outside
    document.addEventListener('touchstart', function(e) {
      if (!e.target.closest('[data-size-overlay]') && !e.target.closest('[data-product-card]')) {
        document.querySelectorAll('.product-card.is-touched').forEach(card => {
          card.classList.remove('is-touched');
        });
      }
    });
  }
  
  // Size button click - add to cart
  document.addEventListener('click', async function(e) {
    const sizeBtn = e.target.closest('[data-size-add]');
    if (!sizeBtn || sizeBtn.disabled) return;
    
    e.preventDefault();
    const variantId = sizeBtn.dataset.sizeAdd;
    
    sizeBtn.disabled = true;
    sizeBtn.textContent = '...';
    
    try {
      const response = await fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          id: variantId,
          quantity: 1
        })
      });
      
      if (response.ok) {
        document.dispatchEvent(new CustomEvent('cart:item-added'));
        document.dispatchEvent(new CustomEvent('cart:updated'));
        
        // Visual feedback
        sizeBtn.textContent = '✓';
        setTimeout(() => {
          const card = sizeBtn.closest('.product-card');
          if (card) card.classList.remove('is-touched');
        }, 500);
      }
    } catch (error) {
      console.error('Add to cart error:', error);
    }
  });
  
  // Quick add button click (desktop)
  document.addEventListener('click', async function(e) {
    const quickAdd = e.target.closest('[data-quick-add]');
    if (!quickAdd) return;
    
    e.preventDefault();
    const variantId = quickAdd.dataset.variantId;
    
    if (variantId) {
      // Single variant - add directly
      quickAdd.disabled = true;
      const originalText = quickAdd.textContent;
      quickAdd.textContent = '...';
      
      try {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: variantId,
            quantity: 1
          })
        });
        
        if (response.ok) {
          document.dispatchEvent(new CustomEvent('cart:item-added'));
          document.dispatchEvent(new CustomEvent('cart:updated'));
          quickAdd.textContent = '✓ Hinzugefügt';
          setTimeout(() => {
            quickAdd.textContent = originalText;
            quickAdd.disabled = false;
          }, 2000);
        }
      } catch (error) {
        console.error('Add to cart error:', error);
        quickAdd.textContent = originalText;
        quickAdd.disabled = false;
      }
    } else {
      // Multiple variants - go to product page
      const card = quickAdd.closest('[data-product-card]');
      const url = card?.dataset.productUrl;
      if (url) window.location.href = url;
    }
  });
  
  // Wishlist toggle
  document.addEventListener('click', function(e) {
    const wishlistBtn = e.target.closest('[data-wishlist-toggle]');
    if (!wishlistBtn) return;
    
    e.preventDefault();
    wishlistBtn.classList.toggle('is-active');
    
    const productId = wishlistBtn.dataset.wishlistToggle;
    // Store in localStorage or send to backend
    let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
    
    if (wishlistBtn.classList.contains('is-active')) {
      if (!wishlist.includes(productId)) {
        wishlist.push(productId);
      }
    } else {
      wishlist = wishlist.filter(id => id !== productId);
    }
    
    localStorage.setItem('wishlist', JSON.stringify(wishlist));
  });
  
  // Initialize wishlist state
  const wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
  wishlist.forEach(id => {
    const btn = document.querySelector(`[data-wishlist-toggle="${id}"]`);
    if (btn) btn.classList.add('is-active');
  });
});
</script>
